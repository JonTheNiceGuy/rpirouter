# Generated by Ansible
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
{% for nat in iptables_nats %}
{% if nat.in is not defined %}
{% if nat.comment is defined %}
# {{ nat.comment }}
{% endif %}
--append POSTROUTING {% if nat.protocol is defined -%}
    --protocol {{ nat.protocol }} {% endif %}{% if nat.source is defined -%}
    --source {{ nat.source }} {% endif %}{% if nat.destination is defined -%}
    --destination {{ nat.destination }} {% endif %}{% if nat.out is defined -%}
    --out-interface {{ nat.out }} {% endif %}{% if nat.port is defined -%}
    --dport {{ nat.port }} {% endif -%}
    --jump {{ nat.action | default('MASQUERADE') }}
    {%- if nat.hide is defined %} --to {{ nat.hide }}{% endif %}
{% else %}
{% if nat.comment is defined %}
# {{ nat.comment }}
{% endif %}
--append POSTROUTING ! --out-interface {{ nat.in }} --jump MASQUERADE
{% endif %}

{% endfor %}
COMMIT
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
--append FORWARD --match conntrack --ctstate RELATED,ESTABLISHED --jump ACCEPT
{% for nat in iptables_nats %}
{% if nat.comment is defined %}
# {{ nat.comment }}
{% endif %}
--append FORWARD {% if nat.protocol is defined -%}
    --protocol {{ nat.protocol }} {% endif %}{% if nat.source is defined -%}
    --source {{ nat.source }} {% endif %}{% if nat.destination is defined -%}
    --destination {{ nat.destination }} {% endif %}{% if nat.in is defined -%}
    --in-interface {{ nat.in }} {% endif %}{% if nat.out is defined -%}
    --out-interface {{ nat.out }} {% endif %}{% if nat.port is defined -%}
    --dport {{ nat.port }} {% endif -%}
    --jump {{ nat.action | default('ACCEPT') }}
    {%- if nat.hide is defined %} --to {{ nat.hide }}{% endif %}

{% endfor %}
--append INPUT --match conntrack --ctstate RELATED,ESTABLISHED --jump ACCEPT
# Allow DHCP on usb0
--append INPUT --in-interface usb0 --protocol udp --dport 67:68 --sport 67:68 -j ACCEPT
# Allow DNS on usb0
--append INPUT --in-interface usb0 --protocol udp --dport 53 -j ACCEPT
{% if use_libComposite | default(true) | bool %}
# Allow DHCP on usb1
--append INPUT --in-interface usb1 --protocol udp --dport 67:68 --sport 67:68 -j ACCEPT
# Allow DNS on usb1
--append INPUT --in-interface usb1 --protocol udp --dport 53 -j ACCEPT
{% endif %}

{% for rule in iptables_rules %}
{% if rule.comment is defined %}
# {{ rule.comment }}
{% endif %}
--append INPUT {% if rule.protocol is defined -%}
    --protocol {{ rule.protocol }} {% endif %}{% if rule.in is defined -%}
    --in-interface {{ rule.in }} {% endif %}{% if rule.out is defined -%}
    --out-interface {{ rule.out }} {% endif %}{% if rule.port is defined -%}
    --dport {{ rule.port }} {% endif -%}
    --jump {{ rule.action | default('ACCEPT') }}

{% endfor %}
COMMIT
