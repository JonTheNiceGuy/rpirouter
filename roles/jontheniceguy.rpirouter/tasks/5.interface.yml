---
- name: Configure Packages to install on next boot
  become: true
  lineinfile:
    line: "bridge-utils"
    path: "{{ item.key }}/root/packages"
    owner: "0"
    group: "0"
    mode: "0600"
    create: yes
  loop: "{{ root_volume | dict2items }}"
  loop_control:
    label: "{{ item.value }}"
  when: create_bridge | bool

- name: Configure bridge-utils
  copy:
    content: |
      BRIDGE_HOTPLUG=yes
    dest: "{{ item.key }}/etc/default/bridge-utils"
    owner: "0"
    group: "0"
    mode: "0644"
  loop: "{{ root_volume | dict2items }}"
  loop_control:
    label: "{{ item.value }}"
  when: not create_bridge | bool

- name: Load interface.d style configuration
  include_tasks: 5a.interface.d.yml
  when: use_interface_d | bool

- name: Load systemd-networkd style configuration
  include_tasks: 5b.systemd-networkd.yml
  when: not use_interface_d | bool

- name: Update hosts file with hostname
  lineinfile:
    path: "{{ item.key }}/etc/hosts"
    regexp: '^127\.0\.1\.1\s+\S+\s*$'
    line: "127.0.1.1 {{ hostname }}.{{ dns_name }} {{ hostname }}"
    owner: "0"
    group: "0"
    mode: "0644"
  loop: "{{ root_volume | dict2items }}"
  loop_control:
    label: "{{ item.value }}"

- name: Update hosts file with hostname for usb0
  lineinfile:
    path: "{{ item.key }}/etc/hosts"
    line: "{{ usb0_interface_router }} {{ hostname }}.{{ dns_name }} {{ hostname }}"
    owner: "0"
    group: "0"
    mode: "0644"
  when: usb0_interface_cidr | length > 0
  loop: "{{ root_volume | dict2items }}"
  loop_control:
    label: "{{ item.value }}"

- name: Update hosts file with hostname for usb0-ipv6
  lineinfile:
    path: "{{ item.key }}/etc/hosts"
    line: "{{ usb0_interface_router6 }} {{ hostname }}.{{ dns_name }} {{ hostname }}"
    owner: "0"
    group: "0"
    mode: "0644"
  when: usb0_interface_cidr6 | length > 0
  loop: "{{ root_volume | dict2items }}"
  loop_control:
    label: "{{ item.value }}"

- name: Update hosts file with hostname for usb1
  lineinfile:
    path: "{{ item.key }}/etc/hosts"
    line: "{{ usb1_interface_router }} {{ hostname }}.{{ dns_name }} {{ hostname }}"
    owner: "0"
    group: "0"
    mode: "0644"
  loop: "{{ root_volume | dict2items }}"
  loop_control:
    label: "{{ item.value }}"
  when: 
  - use_libComposite | bool
  - usb1_interface_cidr | length > 0
  - not create_bridge | bool

- name: Update hosts file with hostname for usb1-ipv6
  lineinfile:
    path: "{{ item.key }}/etc/hosts"
    line: "{{ usb1_interface_router6 }} {{ hostname }}.{{ dns_name }} {{ hostname }}"
    owner: "0"
    group: "0"
    mode: "0644"
  loop: "{{ root_volume | dict2items }}"
  loop_control:
    label: "{{ item.value }}"
  when: 
  - use_libComposite | bool
  - usb1_interface_cidr6 | length > 0
  - not create_bridge | bool

- name: Update hostname file
  lineinfile:
    path: "{{ item.key }}/etc/hostname"
    regexp: '^.*$'
    line: "{{ hostname }}.{{ dns_name }}"
    owner: "0"
    group: "0"
    mode: "0644"
  loop: "{{ root_volume | dict2items }}"
  loop_control:
    label: "{{ item.value }}"